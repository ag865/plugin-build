name: Build VSTO MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:

      - uses: actions/checkout@v4

      # Download Visual Studio installer
      - name: Download Visual Studio installer
        shell: powershell
        run: |
          Invoke-WebRequest `
            -Uri "https://aka.ms/vs/17/release/vs_Enterprise.exe" `
            -OutFile "vs_installer.exe"

      # Install VS + Installer Projects
      - name: Install Visual Studio workloads
        shell: cmd
        run: |
          vs_installer.exe ^
            --productId Microsoft.VisualStudio.Product.Enterprise ^
            --quiet --wait --norestart --nocache ^
            --add Microsoft.VisualStudio.Workload.ManagedDesktop ^
            --add Microsoft.VisualStudio.Component.VSSDK ^
            --add Microsoft.VisualStudio.Component.VSInstallerProjects ^
            --includeRecommended

      # Locate devenv
      - name: Locate devenv
        id: finddevenv
        shell: powershell
        run: |
          $path = Get-ChildItem -Filter devenv.com -Recurse "C:\Program Files\Microsoft Visual Studio" | 
                  Select-Object -First 1 -ExpandProperty FullName
          if (-not $path) { throw "devenv.com not found" }
          echo "::set-output name=path::$path"

      # Build the MSI
      - name: Build MSI
        shell: cmd
        run: |
          "%{{ steps.finddevenv.outputs.path }}" DavigoldExcel.sln /build Release

      # Rename output
      - name: Move MSI
        shell: cmd
        run: |
          copy DavigoldAddinInstaller\Release\DavigoldAddinInstaller.msi DavigoldAddinInstaller\Release\DavigoldAddinInstaller-latest.msi

      # Upload MSI to API
      - name: Upload MSI
        shell: cmd
        run: |
          curl.exe -X POST ^
            -F "file=@DavigoldAddinInstaller\Release\DavigoldAddinInstaller-latest.msi" ^
            -F "version=latest" ^
            https://localhost:7106/api/plugin-version
