name: Build MSI Installer

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    name: Build MSI
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1
        with:
          updateAssemblyInfo: true
          # This helps ensure the DLLs have the correct version for WiX to read

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet Packages
        run: nuget restore DavigoldExcel.sln

      - name: Build VSTO Add-ins
        shell: cmd
        run: |
          msbuild DavigoldExcel.sln /p:Configuration=Release /p:Platform="Any CPU" /t:DavigoldExcel;DavigoldPowerpoint;DavigoldWordAddin /verbosity:minimal

      - name: Build WiX Installer
        run: |
          msbuild Setup/Setup.wixproj /p:Configuration=Release /p:Platform=x86 /verbosity:minimal

      - name: Rename MSI
        shell: cmd
        run: |
          move Setup\bin\Release\DavigoldAddinInstaller.msi Setup\bin\Release\DavigoldAddinInstaller-${{ steps.gitversion.outputs.FullSemVer }}.msi

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DavigoldAddinInstaller
          path: Setup/bin/Release/DavigoldAddinInstaller-${{ steps.gitversion.outputs.FullSemVer }}.msi

      # Note: The original script uploaded to localhost. This will likely fail in CI unless a tunnel is set up.
      # Uncomment and update the URL if you have a real deployment target.
      # - name: Upload MSI to API
      #   shell: cmd
      #   run: |
      #     curl -X POST ^
      #       -F "file=@Setup\bin\Release\DavigoldAddinInstaller-${{ steps.gitversion.outputs.FullSemVer }}.msi" ^
      #       -F "version=${{ steps.gitversion.outputs.FullSemVer }}" ^
      #       -k ^
      #       https://localhost:7106/api/plugin-version
