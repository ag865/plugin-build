name: Build VSTO MSI
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      # 1. Download Visual Studio Installer
      - name: Download Visual Studio Installer
        shell: powershell
        run: |
          Invoke-WebRequest `
            -Uri "https://aka.ms/vs/17/release/vs_Enterprise.exe" `
            -OutFile "vs_installer.exe"

      # 2. Install Visual Studio with the "Installer Projects" workload
      - name: Install Visual Studio (minimal + vdproj support)
        shell: cmd
        run: |
          vs_installer.exe ^
            --quiet --wait --norestart ^
            --add Microsoft.VisualStudio.Workload.ManagedDesktop ^
            --add Microsoft.VisualStudio.Component.VSSDK ^
            --add Microsoft.VisualStudio.Component.VSInstallerProjects ^
            --includeRecommended

      # 3. Locate devenv after installation
      - name: Locate devenv.com
        id: finddevenv
        shell: powershell
        run: |
          $path = Get-ChildItem -Recurse "C:\Program Files" -Filter devenv.com -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          if (-not $path) { Write-Error "devenv.com not found"; exit 1 }
          echo "::set-output name=devenv::$path"

      # 4. Build MSI
      - name: Build Solution
        shell: cmd
        run: |
          "%{{ steps.finddevenv.outputs.devenv }}" DavigoldExcel.sln /build Release

      # 5. Rename MSI with GitVersion or your own version
      - name: Rename MSI
        shell: cmd
        run: |
          set SRC=DavigoldAddinInstaller\Release\DavigoldAddinInstaller.msi
          set DST=DavigoldAddinInstaller\Release\DavigoldAddinInstaller-latest.msi
          copy "%SRC%" "%DST%"
